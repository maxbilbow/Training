package fjwa.repository;

import java.util.List;

import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.PersistenceException;
import javax.persistence.Query;
import javax.persistence.TypedQuery;

import org.hibernate.HibernateException;

import click.rmx.Tests;
import fjwa.RMXError;
import fjwa.RMXException;

public abstract class AbstractRepository<E> implements EntityRepository<E> {

	@PersistenceContext
	protected EntityManager em;

	@Override
	public E save(E entity) throws RMXException {
		try {
			em.persist(entity);
			em.flush();
		} catch (Exception e) {
			throw RMXException.unexpected(e);
		}
		return entity;
	}

	@Override
	public E remove(E entity) throws RMXException {	
		if (entity != null) 
			try {
				em.remove(em.contains(entity) ? entity : em.merge(entity));
				em.flush();
			} catch (Exception e) {
				throw RMXException.unexpected(e);
			} 
		return entity;
	}

	protected abstract String selectAllFromTable();

	@Override
	public E synchronize(E entity) throws RMXException {
		try {
//			if (em.contains(entity)) {
				em.merge(entity);
				em.flush();
//			}
		} catch (Exception e) {
			throw RMXException.unexpected(e);
		}
		return entity; //TODO: check this is correct
	}
	
	protected abstract class TypedQueryPair {
		public final String query;
		public final Class<?> Class;
		public TypedQueryPair(String query, Class<?> Class) {
			this.query = query;
			this.Class = Class;
		}
	}
	
	protected abstract TypedQueryPair FIND_ALL();
	@Override
	public List<E> loadAll() throws RMXException {
		try {
			TypedQuery<E> query = em.createQuery(FIND_ALL().query, FIND_ALL().Class);//, getType());
			List<E> entities = query.getResultList();
			return entities;
		} catch (Exception e) {
			throw RMXException.unexpected(e);
		}

	}

	@Override
	public Object executeQuery(String query) throws RMXException {
		Object result = null;
		try {
			Query q = em.createQuery(query);
			result = q.getSingleResult();
		} catch (Exception e) {
			throw RMXException.unexpected(e);
		}
		return result;
	}
	
	
	@Override
	public Object queryList(String query) throws RMXException {
		Object result = null;
		try {
			Query q = em.createQuery(query);
			result = q.getResultList();//getSingleResult();
		} catch (Exception e) {
			throw RMXException.unexpected(e);
		}
		return result;
	}
}
